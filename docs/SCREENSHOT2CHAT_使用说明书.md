# Screenshot2Chat è¯¦ç»†ä½¿ç”¨è¯´æ˜ä¹¦

## ğŸ“– ç›®å½•

- [1. æ¦‚è¿°](#1-æ¦‚è¿°)
- [2. ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
- [3. å®‰è£…ä¸é…ç½®](#3-å®‰è£…ä¸é…ç½®)
- [4. æ ¸å¿ƒç»„ä»¶è¯¦è§£](#4-æ ¸å¿ƒç»„ä»¶è¯¦è§£)
- [5. å¿«é€Ÿå…¥é—¨](#5-å¿«é€Ÿå…¥é—¨)
- [6. é«˜çº§ä½¿ç”¨](#6-é«˜çº§ä½¿ç”¨)
- [7. é…ç½®ç®¡ç†](#7-é…ç½®ç®¡ç†)
- [8. æ€§èƒ½ä¼˜åŒ–](#8-æ€§èƒ½ä¼˜åŒ–)
- [9. æ•…éšœæ’é™¤](#9-æ•…éšœæ’é™¤)
- [10. API å‚è€ƒ](#10-api-å‚è€ƒ)
- [11. æœ€ä½³å®è·µ](#11-æœ€ä½³å®è·µ)
- [12. å¸¸è§é—®é¢˜](#12-å¸¸è§é—®é¢˜)

---

## 1. æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯ Screenshot2Chatï¼Ÿ

Screenshot2Chat æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ã€æ¨¡å—åŒ–çš„èŠå¤©æˆªå›¾åˆ†ææ¡†æ¶ï¼Œèƒ½å¤Ÿä»å„ç§èŠå¤©åº”ç”¨çš„æˆªå›¾ä¸­è‡ªåŠ¨æå–ç»“æ„åŒ–ä¿¡æ¯ã€‚è¯¥ç³»ç»Ÿé‡‡ç”¨å…ˆè¿›çš„è®¡ç®—æœºè§†è§‰å’Œè‡ªç„¶è¯­è¨€å¤„ç†æŠ€æœ¯ï¼Œæ”¯æŒï¼š

- âœ… **åº”ç”¨æ— å…³**: æ”¯æŒå¾®ä¿¡ã€WhatsAppã€Telegramã€Discordã€Instagram ç­‰ä»»ä½•èŠå¤©åº”ç”¨
- âœ… **æ™ºèƒ½æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«æ–‡æœ¬æ¡†ã€èŠå¤©æ°”æ³¡ã€å¤´åƒã€è¡¨æƒ…ç­‰å…ƒç´ 
- âœ… **å¸ƒå±€åˆ†æ**: è‡ªåŠ¨è¯†åˆ«å•åˆ—/åŒåˆ—å¸ƒå±€ï¼ŒåŒºåˆ†ä¸åŒè¯´è¯è€…
- âœ… **è·¨æˆªå›¾å­¦ä¹ **: æ”¯æŒè®°å¿†åŠŸèƒ½ï¼Œä¿æŒè¯´è¯è€…èº«ä»½çš„ä¸€è‡´æ€§
- âœ… **é«˜åº¦å¯æ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
- âœ… **æ€§èƒ½ç›‘æ§**: å†…ç½®æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ

### 1.2 ä¸»è¦ç‰¹æ€§

#### æ ¸å¿ƒåŠŸèƒ½
- **æ–‡æœ¬æ£€æµ‹**: åŸºäº PaddleOCR çš„é«˜ç²¾åº¦æ–‡æœ¬æ£€æµ‹å’Œè¯†åˆ«
- **æ°”æ³¡æ£€æµ‹**: æ™ºèƒ½è¯†åˆ«èŠå¤©æ°”æ³¡å’Œè¯´è¯è€…èº«ä»½
- **æ˜µç§°æå–**: è‡ªåŠ¨æå–èŠå¤©ç•Œé¢ä¸­çš„ç”¨æˆ·æ˜µç§°
- **è¯´è¯è€…è¯†åˆ«**: åŒºåˆ†ä¸åŒè¯´è¯è€…çš„æ¶ˆæ¯
- **å¸ƒå±€åˆ†æ**: è¯†åˆ«èŠå¤©ç•Œé¢çš„å¸ƒå±€ç±»å‹

#### æŠ€æœ¯ç‰¹æ€§
- **æµæ°´çº¿æ¶æ„**: çµæ´»çš„æµæ°´çº¿ç³»ç»Ÿï¼Œæ”¯æŒè‡ªå®šä¹‰å¤„ç†æµç¨‹
- **å¹¶è¡Œå¤„ç†**: æ”¯æŒå¤šæ­¥éª¤å¹¶è¡Œæ‰§è¡Œï¼Œæå‡å¤„ç†é€Ÿåº¦
- **æ¡ä»¶æ‰§è¡Œ**: æ”¯æŒåŸºäºæ¡ä»¶çš„æ­¥éª¤æ‰§è¡Œ
- **é…ç½®ç®¡ç†**: ä¸‰å±‚é…ç½®ç³»ç»Ÿï¼ˆé»˜è®¤/ç”¨æˆ·/è¿è¡Œæ—¶ï¼‰
- **æ€§èƒ½ç›‘æ§**: å®æ—¶ç›‘æ§å¤„ç†æ€§èƒ½å’Œèµ„æºä½¿ç”¨
- **ç»“æ„åŒ–æ—¥å¿—**: å®Œæ•´çš„æ—¥å¿—è®°å½•ç³»ç»Ÿ

### 1.3 é€‚ç”¨åœºæ™¯


- ğŸ“± **ç¤¾äº¤åª’ä½“åˆ†æ**: åˆ†æèŠå¤©è®°å½•ï¼Œæå–å¯¹è¯å†…å®¹
- ğŸ” **å†…å®¹å®¡æ ¸**: è‡ªåŠ¨æ£€æµ‹å’Œåˆ†ç±»èŠå¤©å†…å®¹
- ğŸ“Š **æ•°æ®æŒ–æ˜**: ä»èŠå¤©æˆªå›¾ä¸­æå–ç»“æ„åŒ–æ•°æ®
- ğŸ¤– **èŠå¤©æœºå™¨äººè®­ç»ƒ**: æ”¶é›†å¯¹è¯æ•°æ®ç”¨äºè®­ç»ƒ
- ğŸ“ **æ–‡æ¡£ç”Ÿæˆ**: å°†èŠå¤©è®°å½•è½¬æ¢ä¸ºæ–‡æ¡£æ ¼å¼
- ğŸ“ **ç ”ç©¶åˆ†æ**: å­¦æœ¯ç ”ç©¶ä¸­çš„å¯¹è¯åˆ†æ

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Screenshot2Chat                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Detectors   â”‚  â”‚  Extractors  â”‚  â”‚  Pipeline    â”‚  â”‚
â”‚  â”‚  (æ£€æµ‹å™¨)     â”‚  â”‚  (æå–å™¨)     â”‚  â”‚  (æµæ°´çº¿)     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ TextDetector â”‚  â”‚ Nickname     â”‚  â”‚ Step         â”‚  â”‚
â”‚  â”‚ BubbleDetect â”‚  â”‚ Speaker      â”‚  â”‚ Execution    â”‚  â”‚
â”‚  â”‚ AvatarDetect â”‚  â”‚ Layout       â”‚  â”‚ Dependency   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Config     â”‚  â”‚  Monitoring  â”‚  â”‚   Logging    â”‚  â”‚
â”‚  â”‚  (é…ç½®ç®¡ç†)   â”‚  â”‚  (æ€§èƒ½ç›‘æ§)   â”‚  â”‚  (æ—¥å¿—ç³»ç»Ÿ)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            Core (æ ¸å¿ƒæŠ½è±¡å±‚)                      â”‚   â”‚
â”‚  â”‚  BaseDetector | BaseExtractor | DataModels      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ¨¡å—è¯´æ˜

#### æ ¸å¿ƒæ¨¡å— (core/)
- **BaseDetector**: æ£€æµ‹å™¨åŸºç±»ï¼Œå®šä¹‰æ£€æµ‹å™¨æ¥å£
- **BaseExtractor**: æå–å™¨åŸºç±»ï¼Œå®šä¹‰æå–å™¨æ¥å£
- **DataModels**: æ•°æ®æ¨¡å‹ï¼ˆDetectionResult, ExtractionResultï¼‰
- **Exceptions**: è‡ªå®šä¹‰å¼‚å¸¸ç±»

#### æ£€æµ‹å™¨æ¨¡å— (detectors/)
- **TextDetector**: æ–‡æœ¬æ£€æµ‹å™¨ï¼ŒåŸºäº PaddleOCR
- **BubbleDetector**: èŠå¤©æ°”æ³¡æ£€æµ‹å™¨ï¼Œè¯†åˆ«è¯´è¯è€…

#### æå–å™¨æ¨¡å— (extractors/)
- **NicknameExtractor**: æ˜µç§°æå–å™¨
- **SpeakerExtractor**: è¯´è¯è€…è¯†åˆ«å™¨
- **LayoutExtractor**: å¸ƒå±€åˆ†æå™¨

#### æµæ°´çº¿æ¨¡å— (pipeline/)
- **Pipeline**: æµæ°´çº¿ç®¡ç†å™¨
- **PipelineStep**: æµæ°´çº¿æ­¥éª¤å®šä¹‰
- **StepType**: æ­¥éª¤ç±»å‹æšä¸¾

#### é…ç½®æ¨¡å— (config/)
- **ConfigManager**: é…ç½®ç®¡ç†å™¨ï¼Œæ”¯æŒä¸‰å±‚é…ç½®

#### ç›‘æ§æ¨¡å— (monitoring/)
- **PerformanceMonitor**: æ€§èƒ½ç›‘æ§å™¨

#### æ—¥å¿—æ¨¡å— (logging/)
- **StructuredLogger**: ç»“æ„åŒ–æ—¥å¿—è®°å½•å™¨

#### æ¨¡å‹ç®¡ç† (models/)
- **ModelManager**: æ¨¡å‹ç®¡ç†å™¨ï¼Œç»Ÿä¸€ç®¡ç†å„ç§æ¨¡å‹

---

## 3. å®‰è£…ä¸é…ç½®

### 3.1 ç³»ç»Ÿè¦æ±‚


**ç¡¬ä»¶è¦æ±‚**:
- CPU: 2æ ¸å¿ƒä»¥ä¸Šï¼ˆæ¨è4æ ¸å¿ƒï¼‰
- å†…å­˜: 4GB ä»¥ä¸Šï¼ˆæ¨è8GBï¼‰
- ç¡¬ç›˜: 2GB å¯ç”¨ç©ºé—´ï¼ˆç”¨äºæ¨¡å‹å­˜å‚¨ï¼‰
- GPU: å¯é€‰ï¼ŒCUDA æ”¯æŒçš„ NVIDIA GPUï¼ˆç”¨äºåŠ é€Ÿï¼‰

**è½¯ä»¶è¦æ±‚**:
- Python: 3.8 æˆ–æ›´é«˜ç‰ˆæœ¬
- æ“ä½œç³»ç»Ÿ: Windows 10+, macOS 10.14+, Linux (Ubuntu 18.04+)
- PaddlePaddle: 2.4.0 æˆ–æ›´é«˜ç‰ˆæœ¬

### 3.2 å®‰è£…æ­¥éª¤

#### æ–¹æ³•1: ä½¿ç”¨ pip å®‰è£…ï¼ˆæ¨èï¼‰

```bash
# åŸºç¡€å®‰è£…
pip install screenshot2chat

# å®‰è£… PaddleOCR ä¾èµ–
pip install paddlepaddle paddleocr

# GPU ç‰ˆæœ¬ï¼ˆå¦‚æœæœ‰ NVIDIA GPUï¼‰
pip install paddlepaddle-gpu
```

#### æ–¹æ³•2: ä»æºç å®‰è£…

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/your-org/screenshot2chat.git
cd screenshot2chat

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å¼€å‘æ¨¡å¼å®‰è£…
pip install -e .
```

### 3.3 æ¨¡å‹ä¸‹è½½

Screenshot2Chat éœ€è¦ä¸‹è½½ OCR æ¨¡å‹æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚

#### è‡ªåŠ¨ä¸‹è½½ï¼ˆæ¨èï¼‰

```python
from screenshot2chat.models import ModelManager

# åˆ›å»ºæ¨¡å‹ç®¡ç†å™¨
model_manager = ModelManager()

# ä¸‹è½½é»˜è®¤æ¨¡å‹
model_manager.download_model("PP-OCRv5_server_det")
model_manager.download_model("PP-OCRv5_server_rec")

print("æ¨¡å‹ä¸‹è½½å®Œæˆï¼")
```

#### æ‰‹åŠ¨ä¸‹è½½

1. è®¿é—® [PaddleOCR æ¨¡å‹åº“](https://github.com/PaddlePaddle/PaddleOCR/blob/release/2.7/doc/doc_ch/models_list.md)
2. ä¸‹è½½æ‰€éœ€æ¨¡å‹
3. è§£å‹åˆ° `models/` ç›®å½•

```
models/
â”œâ”€â”€ PP-OCRv5_server_det/
â”‚   â”œâ”€â”€ inference.pdmodel
â”‚   â”œâ”€â”€ inference.pdiparams
â”‚   â””â”€â”€ inference.pdiparams.info
â””â”€â”€ PP-OCRv5_server_rec/
    â”œâ”€â”€ inference.pdmodel
    â”œâ”€â”€ inference.pdiparams
    â””â”€â”€ inference.pdiparams.info
```

### 3.4 éªŒè¯å®‰è£…

```python
import screenshot2chat
import numpy as np

# æ£€æŸ¥ç‰ˆæœ¬
print(f"Screenshot2Chat ç‰ˆæœ¬: {screenshot2chat.__version__}")

# æµ‹è¯•å¯¼å…¥
from screenshot2chat.detectors import TextDetector
from screenshot2chat.pipeline import Pipeline

# åˆ›å»ºæµ‹è¯•æ£€æµ‹å™¨
detector = TextDetector(config={"auto_load": False})
print("âœ“ å®‰è£…éªŒè¯æˆåŠŸï¼")
```

### 3.5 ç¯å¢ƒå˜é‡é…ç½®

å¯é€‰çš„ç¯å¢ƒå˜é‡é…ç½®ï¼š

```bash
# è®¾ç½®æ¨¡å‹ç›®å½•
export PADDLE_MODEL_DIR=/path/to/models

# è®¾ç½®æ—¥å¿—çº§åˆ«
export SCREENSHOT2CHAT_LOG_LEVEL=INFO

# å¯ç”¨ GPU
export CUDA_VISIBLE_DEVICES=0
```

---

## 4. æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 4.1 æ£€æµ‹å™¨ (Detectors)

æ£€æµ‹å™¨è´Ÿè´£åœ¨å›¾åƒä¸­è¯†åˆ«ç‰¹å®šå…ƒç´ ã€‚

#### 4.1.1 TextDetector (æ–‡æœ¬æ£€æµ‹å™¨)

**åŠŸèƒ½**: æ£€æµ‹å›¾åƒä¸­çš„æ–‡æœ¬åŒºåŸŸ

**æ”¯æŒçš„åç«¯**:
- `paddleocr`: PaddleOCR æ ‡å‡†ç‰ˆ
- `PP-OCRv5_server_det`: PaddleOCR æœåŠ¡å™¨ç‰ˆï¼ˆæ¨èï¼‰

**åŸºæœ¬ç”¨æ³•**:

```python
from screenshot2chat.detectors import TextDetector
import cv2

# åˆ›å»ºæ£€æµ‹å™¨
detector = TextDetector(config={
    "backend": "PP-OCRv5_server_det",
    "lang": "multi",  # æ”¯æŒå¤šè¯­è¨€
    "model_dir": "models/",
    "auto_load": True  # è‡ªåŠ¨åŠ è½½æ¨¡å‹
})

# åŠ è½½å›¾åƒ
image = cv2.imread("chat_screenshot.png")

# æ‰§è¡Œæ£€æµ‹
results = detector.detect(image)

# å¤„ç†ç»“æœ
for result in results:
    print(f"æ–‡æœ¬æ¡†: {result.bbox}")
    print(f"ç½®ä¿¡åº¦: {result.score}")
    print(f"ç±»åˆ«: {result.category}")
```

**é…ç½®å‚æ•°**:


| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `backend` | str | "PP-OCRv5_server_det" | OCR åç«¯ç±»å‹ |
| `lang` | str | "multi" | è¯­è¨€ä»£ç  (en, zh, multi ç­‰) |
| `model_dir` | str | è‡ªåŠ¨æ£€æµ‹ | æ¨¡å‹ç›®å½•è·¯å¾„ |
| `auto_load` | bool | False | æ˜¯å¦è‡ªåŠ¨åŠ è½½æ¨¡å‹ |
| `use_gpu` | bool | False | æ˜¯å¦ä½¿ç”¨ GPU |
| `det_db_thresh` | float | 0.3 | æ£€æµ‹é˜ˆå€¼ |
| `det_db_box_thresh` | float | 0.5 | è¾¹ç•Œæ¡†é˜ˆå€¼ |

**è¿”å›å€¼**: `List[DetectionResult]`

æ¯ä¸ª `DetectionResult` åŒ…å«:
- `bbox`: è¾¹ç•Œæ¡†åæ ‡ [x_min, y_min, x_max, y_max]
- `score`: ç½®ä¿¡åº¦åˆ†æ•° (0.0-1.0)
- `category`: ç±»åˆ«æ ‡ç­¾ ("text")
- `metadata`: é¢å¤–ä¿¡æ¯ï¼ˆå¦‚è¯†åˆ«çš„æ–‡æœ¬å†…å®¹ï¼‰

#### 4.1.2 BubbleDetector (æ°”æ³¡æ£€æµ‹å™¨)

**åŠŸèƒ½**: æ£€æµ‹èŠå¤©æ°”æ³¡å¹¶è¯†åˆ«è¯´è¯è€…

**ç‰¹æ€§**:
- è‡ªåŠ¨è¯†åˆ«å•åˆ—/åŒåˆ—å¸ƒå±€
- è·¨æˆªå›¾è®°å¿†å­¦ä¹ 
- è¯´è¯è€…èº«ä»½è·Ÿè¸ª
- æ”¯æŒè®°å¿†æŒä¹…åŒ–

**åŸºæœ¬ç”¨æ³•**:

```python
from screenshot2chat.detectors import BubbleDetector
import cv2

# åˆ›å»ºæ£€æµ‹å™¨
detector = BubbleDetector(config={
    "screen_width": 720,
    "memory_path": "chat_memory.json",  # ä¿å­˜è®°å¿†
    "memory_alpha": 0.7,  # è®°å¿†æ›´æ–°ç³»æ•°
    "auto_load": True
})

# éœ€è¦å…ˆæœ‰æ–‡æœ¬æ£€æµ‹ç»“æœ
text_results = text_detector.detect(image)

# æ‰§è¡Œæ°”æ³¡æ£€æµ‹
bubble_results = detector.detect(image, text_boxes=text_results)

# æŸ¥çœ‹ç»“æœ
for bubble in bubble_results:
    speaker = bubble.metadata.get("speaker")  # "A" æˆ– "B"
    layout = bubble.metadata.get("layout")    # å¸ƒå±€ç±»å‹
    print(f"è¯´è¯è€… {speaker}: {bubble.bbox}")

# æŸ¥çœ‹è®°å¿†çŠ¶æ€
memory = detector.get_memory_state()
print(f"å·²å¤„ç†å¸§æ•°: {memory['frame_count']}")
```

**é…ç½®å‚æ•°**:

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `screen_width` | int | 720 | å±å¹•å®½åº¦ï¼ˆåƒç´ ï¼‰ |
| `min_separation_ratio` | float | 0.18 | æœ€å°åˆ—åˆ†ç¦»æ¯”ä¾‹ |
| `memory_alpha` | float | 0.7 | è®°å¿†æ›´æ–°çš„æ»‘åŠ¨å¹³å‡ç³»æ•° |
| `memory_path` | str | None | è®°å¿†æŒä¹…åŒ–æ–‡ä»¶è·¯å¾„ |
| `save_interval` | int | 10 | è‡ªåŠ¨ä¿å­˜é—´éš”ï¼ˆå¸§æ•°ï¼‰ |
| `auto_load` | bool | False | æ˜¯å¦è‡ªåŠ¨åŠ è½½ |

**è®°å¿†ç®¡ç†**:

```python
# é‡ç½®è®°å¿†
detector.reset_memory()

# æ‰‹åŠ¨ä¿å­˜è®°å¿†
detector.save_memory()

# è·å–è®°å¿†çŠ¶æ€
memory = detector.get_memory_state()
```

### 4.2 æå–å™¨ (Extractors)

æå–å™¨ä»æ£€æµ‹ç»“æœä¸­æå–ç»“æ„åŒ–ä¿¡æ¯ã€‚

#### 4.2.1 LayoutExtractor (å¸ƒå±€æå–å™¨)

**åŠŸèƒ½**: åˆ†æèŠå¤©ç•Œé¢çš„å¸ƒå±€ç±»å‹

**æ”¯æŒçš„å¸ƒå±€ç±»å‹**:
- `single`: å•åˆ—å¸ƒå±€
- `double`: æ ‡å‡†åŒåˆ—å¸ƒå±€
- `double_left`: å·¦å¯¹é½åŒåˆ—
- `double_right`: å³å¯¹é½åŒåˆ—

**åŸºæœ¬ç”¨æ³•**:

```python
from screenshot2chat.extractors import LayoutExtractor

# åˆ›å»ºæå–å™¨
extractor = LayoutExtractor(config={
    "screen_width": 720,
    "min_separation_ratio": 0.18
})

# ä»æ–‡æœ¬æ£€æµ‹ç»“æœæå–å¸ƒå±€
layout_result = extractor.extract(text_results, image)

# è·å–å¸ƒå±€ä¿¡æ¯
layout_type = layout_result.data["layout_type"]
is_double = layout_result.data["is_double_column"]
confidence = layout_result.confidence

print(f"å¸ƒå±€ç±»å‹: {layout_type}")
print(f"ç½®ä¿¡åº¦: {confidence:.2f}")
```

**è¿”å›æ•°æ®ç»“æ„**:

```python
{
    "layout_type": "double",        # å¸ƒå±€ç±»å‹
    "is_single_column": False,      # æ˜¯å¦å•åˆ—
    "is_double_column": True,       # æ˜¯å¦åŒåˆ—
    "num_columns": 2,               # åˆ—æ•°
    "left_boxes": [0, 2, 4],        # å·¦åˆ—æ–‡æœ¬æ¡†ç´¢å¼•
    "right_boxes": [1, 3, 5],       # å³åˆ—æ–‡æœ¬æ¡†ç´¢å¼•
    "left_stats": {                 # å·¦åˆ—ç»Ÿè®¡ä¿¡æ¯
        "center": 180.5,
        "center_normalized": 0.25,
        "width": 250.0,
        "count": 3
    },
    "right_stats": {                # å³åˆ—ç»Ÿè®¡ä¿¡æ¯
        "center": 540.5,
        "center_normalized": 0.75,
        "width": 250.0,
        "count": 3
    }
}
```

#### 4.2.2 SpeakerExtractor (è¯´è¯è€…æå–å™¨)

**åŠŸèƒ½**: è¯†åˆ«å’ŒåŒºåˆ†ä¸åŒçš„è¯´è¯è€…

**åŸºæœ¬ç”¨æ³•**:

```python
from screenshot2chat.extractors import SpeakerExtractor

# åˆ›å»ºæå–å™¨
extractor = SpeakerExtractor(config={
    "screen_width": 720
})

# ä»æ°”æ³¡æ£€æµ‹ç»“æœæå–è¯´è¯è€…
speaker_result = extractor.extract(bubble_results, image)

# è·å–è¯´è¯è€…ä¿¡æ¯
speakers = speaker_result.data["speakers"]
for speaker_id, info in speakers.items():
    print(f"è¯´è¯è€… {speaker_id}:")
    print(f"  æ¶ˆæ¯æ•°: {info['message_count']}")
    print(f"  ä½ç½®ç‰¹å¾: {info['position']}")
```

#### 4.2.3 NicknameExtractor (æ˜µç§°æå–å™¨)

**åŠŸèƒ½**: ä»èŠå¤©ç•Œé¢æå–ç”¨æˆ·æ˜µç§°

**åŸºæœ¬ç”¨æ³•**:

```python
from screenshot2chat.extractors import NicknameExtractor

# åˆ›å»ºæå–å™¨
extractor = NicknameExtractor(config={
    "top_k": 3,                    # è¿”å›å‰3ä¸ªå€™é€‰
    "min_top_margin_ratio": 0.05,  # æœ€å°é¡¶éƒ¨è¾¹è·
    "top_region_ratio": 0.2        # é¡¶éƒ¨åŒºåŸŸæ¯”ä¾‹
})

# æå–æ˜µç§°
nickname_result = extractor.extract(text_results, image)

# è·å–æ˜µç§°åˆ—è¡¨
nicknames = nickname_result.data["nicknames"]
for nick in nicknames:
    print(f"æ˜µç§°: {nick['text']}")
    print(f"ç½®ä¿¡åº¦: {nick['nickname_score']:.2f}")
```

### 4.3 æµæ°´çº¿ (Pipeline)

æµæ°´çº¿ç³»ç»Ÿç”¨äºç»„åˆå¤šä¸ªæ£€æµ‹å™¨å’Œæå–å™¨ï¼Œæ„å»ºå®Œæ•´çš„å¤„ç†æµç¨‹ã€‚

#### 4.3.1 åˆ›å»ºæµæ°´çº¿

**æ–¹æ³•1: ä»£ç æ–¹å¼åˆ›å»º**

```python
from screenshot2chat.pipeline import Pipeline, PipelineStep, StepType
from screenshot2chat.detectors import TextDetector, BubbleDetector
from screenshot2chat.extractors import LayoutExtractor

# åˆ›å»ºæµæ°´çº¿
pipeline = Pipeline(name="chat_analysis")

# æ·»åŠ æ–‡æœ¬æ£€æµ‹æ­¥éª¤
text_detector = TextDetector(config={"auto_load": True})
pipeline.add_step(PipelineStep(
    name="text_detection",
    step_type=StepType.DETECTOR,
    component=text_detector
))

# æ·»åŠ æ°”æ³¡æ£€æµ‹æ­¥éª¤ï¼ˆä¾èµ–æ–‡æœ¬æ£€æµ‹ï¼‰
bubble_detector = BubbleDetector(config={"auto_load": True})
pipeline.add_step(PipelineStep(
    name="bubble_detection",
    step_type=StepType.DETECTOR,
    component=bubble_detector,
    depends_on=["text_detection"]
))

# æ·»åŠ å¸ƒå±€æå–æ­¥éª¤
layout_extractor = LayoutExtractor()
pipeline.add_step(PipelineStep(
    name="layout_extraction",
    step_type=StepType.EXTRACTOR,
    component=layout_extractor,
    config={"source": "text_detection"},
    depends_on=["text_detection"]
))

# éªŒè¯æµæ°´çº¿
pipeline.validate()
```

**æ–¹æ³•2: é…ç½®æ–‡ä»¶æ–¹å¼åˆ›å»º**


```yaml
# pipeline_config.yaml
name: "chat_analysis_pipeline"
enable_monitoring: true
parallel_executor: "thread"
max_workers: 4

steps:
  - name: "text_detection"
    step_type: "detector"
    component: "TextDetector"
    config:
      backend: "PP-OCRv5_server_det"
      auto_load: true
    enabled: true

  - name: "bubble_detection"
    step_type: "detector"
    component: "BubbleDetector"
    config:
      screen_width: 720
      memory_path: "chat_memory.json"
    depends_on: ["text_detection"]
    enabled: true

  - name: "layout_extraction"
    step_type: "extractor"
    component: "LayoutExtractor"
    config:
      source: "text_detection"
      screen_width: 720
    depends_on: ["text_detection"]
    enabled: true
```

```python
# ä»é…ç½®æ–‡ä»¶åŠ è½½
pipeline = Pipeline.from_config("pipeline_config.yaml")
```

#### 4.3.2 æ‰§è¡Œæµæ°´çº¿

```python
import cv2

# åŠ è½½å›¾åƒ
image = cv2.imread("chat_screenshot.png")

# æ‰§è¡Œæµæ°´çº¿
results = pipeline.execute(image)

# è·å–å„æ­¥éª¤çš„ç»“æœ
text_results = results.get("text_detection")
bubble_results = results.get("bubble_detection")
layout_results = results.get("layout_extraction")

# å¤„ç†ç»“æœ
print(f"æ£€æµ‹åˆ° {len(text_results)} ä¸ªæ–‡æœ¬æ¡†")
print(f"æ£€æµ‹åˆ° {len(bubble_results)} ä¸ªæ°”æ³¡")
print(f"å¸ƒå±€ç±»å‹: {layout_results.data['layout_type']}")
```

#### 4.3.3 æ¡ä»¶æ‰§è¡Œ

æµæ°´çº¿æ”¯æŒåŸºäºæ¡ä»¶çš„æ­¥éª¤æ‰§è¡Œï¼š

```python
# æ·»åŠ æ¡ä»¶æ­¥éª¤
pipeline.add_step(PipelineStep(
    name="advanced_analysis",
    step_type=StepType.EXTRACTOR,
    component=advanced_extractor,
    condition="len(result.text_detection) > 10",  # åªåœ¨æ–‡æœ¬æ¡†è¶…è¿‡10ä¸ªæ—¶æ‰§è¡Œ
    depends_on=["text_detection"]
))
```

**æ”¯æŒçš„æ¡ä»¶è¡¨è¾¾å¼**:
- `len(result.step_name) > value`: æ£€æŸ¥ç»“æœæ•°é‡
- `result.step_name.field == value`: æ£€æŸ¥å­—æ®µå€¼
- `result.step_name is not None`: æ£€æŸ¥ç»“æœæ˜¯å¦å­˜åœ¨

#### 4.3.4 å¹¶è¡Œæ‰§è¡Œ

æµæ°´çº¿æ”¯æŒå¹¶è¡Œæ‰§è¡Œç‹¬ç«‹çš„æ­¥éª¤ï¼š

```python
# åˆ›å»ºå¹¶è¡Œç»„
pipeline.add_step(PipelineStep(
    name="nickname_extraction",
    step_type=StepType.EXTRACTOR,
    component=nickname_extractor,
    depends_on=["text_detection"],
    parallel_group="group1"  # å¹¶è¡Œç»„ID
))

pipeline.add_step(PipelineStep(
    name="layout_extraction",
    step_type=StepType.EXTRACTOR,
    component=layout_extractor,
    depends_on=["text_detection"],
    parallel_group="group1"  # åŒä¸€å¹¶è¡Œç»„
))

# è¿™ä¸¤ä¸ªæ­¥éª¤ä¼šå¹¶è¡Œæ‰§è¡Œ
```

---

## 5. å¿«é€Ÿå…¥é—¨

### 5.1 ç¬¬ä¸€ä¸ªç¤ºä¾‹ï¼šæ–‡æœ¬æ£€æµ‹

```python
from screenshot2chat.detectors import TextDetector
import cv2

# 1. åˆ›å»ºæ£€æµ‹å™¨
detector = TextDetector(config={
    "backend": "paddleocr",
    "auto_load": True
})

# 2. åŠ è½½å›¾åƒ
image = cv2.imread("chat_screenshot.png")

# 3. æ‰§è¡Œæ£€æµ‹
results = detector.detect(image)

# 4. æ˜¾ç¤ºç»“æœ
print(f"æ£€æµ‹åˆ° {len(results)} ä¸ªæ–‡æœ¬æ¡†")
for i, result in enumerate(results):
    print(f"æ–‡æœ¬æ¡† {i+1}:")
    print(f"  ä½ç½®: {result.bbox}")
    print(f"  ç½®ä¿¡åº¦: {result.score:.2f}")
```

### 5.2 ç¬¬äºŒä¸ªç¤ºä¾‹ï¼šå®Œæ•´åˆ†ææµæ°´çº¿

```python
from screenshot2chat.pipeline import Pipeline, PipelineStep, StepType
from screenshot2chat.detectors import TextDetector, BubbleDetector
from screenshot2chat.extractors import LayoutExtractor, NicknameExtractor
import cv2

# 1. åˆ›å»ºæµæ°´çº¿
pipeline = Pipeline(name="complete_analysis")

# 2. æ·»åŠ æ­¥éª¤
pipeline.add_step(PipelineStep(
    name="text_detection",
    step_type=StepType.DETECTOR,
    component=TextDetector(config={"auto_load": True})
))

pipeline.add_step(PipelineStep(
    name="bubble_detection",
    step_type=StepType.DETECTOR,
    component=BubbleDetector(config={"auto_load": True}),
    depends_on=["text_detection"]
))

pipeline.add_step(PipelineStep(
    name="layout_extraction",
    step_type=StepType.EXTRACTOR,
    component=LayoutExtractor(),
    config={"source": "text_detection"},
    depends_on=["text_detection"]
))

# 3. éªŒè¯æµæ°´çº¿
if pipeline.validate():
    print("âœ“ æµæ°´çº¿é…ç½®æœ‰æ•ˆ")

# 4. æ‰§è¡Œåˆ†æ
image = cv2.imread("chat_screenshot.png")
results = pipeline.execute(image)

# 5. å¤„ç†ç»“æœ
layout = results["layout_extraction"]
print(f"å¸ƒå±€ç±»å‹: {layout.data['layout_type']}")
print(f"ç½®ä¿¡åº¦: {layout.confidence:.2f}")

bubbles = results["bubble_detection"]
print(f"æ£€æµ‹åˆ° {len(bubbles)} ä¸ªèŠå¤©æ°”æ³¡")
```

### 5.3 ç¬¬ä¸‰ä¸ªç¤ºä¾‹ï¼šæ‰¹é‡å¤„ç†

```python
from screenshot2chat.pipeline import Pipeline
from pathlib import Path
import cv2
from tqdm import tqdm

# 1. åˆ›å»ºæµæ°´çº¿
pipeline = Pipeline.from_config("config/basic_pipeline.yaml")

# 2. è·å–æ‰€æœ‰å›¾åƒ
image_dir = Path("screenshots")
image_files = list(image_dir.glob("*.png"))

# 3. æ‰¹é‡å¤„ç†
results_list = []
for image_path in tqdm(image_files, desc="å¤„ç†ä¸­"):
    # åŠ è½½å›¾åƒ
    image = cv2.imread(str(image_path))
    
    # æ‰§è¡Œåˆ†æ
    results = pipeline.execute(image)
    
    # ä¿å­˜ç»“æœ
    results_list.append({
        "file": image_path.name,
        "layout": results["layout_extraction"].data["layout_type"],
        "num_bubbles": len(results["bubble_detection"])
    })

# 4. è¾“å‡ºç»Ÿè®¡
print(f"å¤„ç†å®Œæˆï¼å…±å¤„ç† {len(results_list)} å¼ å›¾åƒ")
```

---

## 6. é«˜çº§ä½¿ç”¨

### 6.1 è‡ªå®šä¹‰æ£€æµ‹å™¨

åˆ›å»ºè‡ªå®šä¹‰æ£€æµ‹å™¨éœ€è¦ç»§æ‰¿ `BaseDetector` ç±»ï¼š

```python
from screenshot2chat.core import BaseDetector, DetectionResult
import numpy as np
from typing import List, Dict, Any, Optional

class CustomDetector(BaseDetector):
    """è‡ªå®šä¹‰æ£€æµ‹å™¨ç¤ºä¾‹"""
    
    def __init__(self, config: Optional[Dict[str, Any]] = None):
        super().__init__(config)
        # åˆå§‹åŒ–è‡ªå®šä¹‰å‚æ•°
        self.threshold = self.get_config("threshold", 0.5)
    
    def load_model(self) -> None:
        """åŠ è½½æ¨¡å‹"""
        # å®ç°æ¨¡å‹åŠ è½½é€»è¾‘
        self.model = YourModel()
        print("æ¨¡å‹åŠ è½½å®Œæˆ")
    
    def detect(self, image: np.ndarray) -> List[DetectionResult]:
        """æ‰§è¡Œæ£€æµ‹"""
        # ç¡®ä¿æ¨¡å‹å·²åŠ è½½
        self.ensure_model_loaded()
        
        # æ‰§è¡Œæ£€æµ‹é€»è¾‘
        raw_results = self.model.predict(image)
        
        # è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
        detection_results = []
        for result in raw_results:
            detection_results.append(
                DetectionResult(
                    bbox=result["bbox"],
                    score=result["score"],
                    category="custom",
                    metadata={"custom_field": result["data"]}
                )
            )
        
        return detection_results
    
    def preprocess(self, image: np.ndarray) -> np.ndarray:
        """é¢„å¤„ç†å›¾åƒ"""
        # å®ç°é¢„å¤„ç†é€»è¾‘
        return image
    
    def postprocess(self, raw_results: Any) -> List[DetectionResult]:
        """åå¤„ç†ç»“æœ"""
        # å®ç°åå¤„ç†é€»è¾‘
        return []

# ä½¿ç”¨è‡ªå®šä¹‰æ£€æµ‹å™¨
detector = CustomDetector(config={"threshold": 0.7})
detector.load_model()
results = detector.detect(image)
```

### 6.2 è‡ªå®šä¹‰æå–å™¨

