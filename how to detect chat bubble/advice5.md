è¿™ä¸ªéœ€æ±‚å˜åŒ–**éå¸¸å…³é”®ï¼Œä¹Ÿéå¸¸çœŸå®**ï¼Œå¾ˆå¤šèŠå¤© Appï¼ˆå°¤å…¶æ˜¯æµ·å¤– / å®¢æœ / ç¾¤èŠ / Web ç‰ˆï¼‰ç¡®å®å­˜åœ¨ï¼š

* æ‰€æœ‰æ°”æ³¡éƒ½é å·¦
* æˆ–æ‰€æœ‰æ°”æ³¡éƒ½é å³
* ä½†**å·¦å³ä»ç„¶å­˜åœ¨ä¸¤æ¡â€œéšå«åˆ—â€**ï¼ˆç¼©è¿›ä¸åŒï¼‰

ä½ ç°åœ¨çš„ç›®æ ‡å·²ç»ä¸æ˜¯ï¼š

> â€œè¯†åˆ«è°æ˜¯ user / talkerâ€

è€Œæ˜¯æ›´åº•å±‚çš„ï¼š

> **åœ¨å®Œå…¨ä¸çŸ¥é“ App ç±»å‹çš„æƒ…å†µä¸‹ï¼ŒæŠŠèŠå¤©æ°”æ³¡è‡ªåŠ¨åˆ†æˆâ€œå·¦åˆ— / å³åˆ—â€ä¸¤è¾¹**

è¿™ä¸ªé—®é¢˜æœ¬è´¨æ˜¯ï¼š

> **åœ¨ 1D çš„ center_x åˆ†å¸ƒä¸­ï¼Œè‡ªåŠ¨åˆ¤æ–­ï¼š
>
> * æ˜¯å•åˆ—ï¼Ÿ
> * è¿˜æ˜¯åŒåˆ—ï¼Ÿ
> * å¦‚æœæ˜¯åŒåˆ—ï¼Œè‡ªåŠ¨åˆ†ä¸¤è¾¹ï¼Ÿ**

ä¸‹é¢æˆ‘ç»™ä½ ä¸€å¥—**å·¥ä¸šçº§ã€å®Œå…¨æ— å…ˆéªŒ App ä¿¡æ¯çš„ Python å®ç°**ã€‚

---

# ä¸€ã€æ ¸å¿ƒç­–ç•¥ï¼ˆè¿™æ˜¯æ•´å¥—ç³»ç»Ÿçš„çµé­‚ï¼‰

æˆ‘ä»¬ä¸å†å¼ºè¡Œå‡è®¾ï¼š

* å·¦ = talker
* å³ = user

è€Œæ˜¯ç»Ÿä¸€å»ºæ¨¡ä¸ºï¼š

```text
æ°”æ³¡æ¨ªå‘å¸ƒå±€ç±»å‹åˆ¤å®š + è‡ªåŠ¨åˆ†åˆ—
```

åˆ†ä¸‰æ­¥ï¼š

```text
TextBoxes
   â†“
æå– center_x
   â†“
åˆ¤æ–­æ˜¯ã€Œå•å³°ã€è¿˜æ˜¯ã€ŒåŒå³°ã€
   â†“
å¦‚æœåŒå³° â†’ èšæˆ left_column / right_column
å¦‚æœå•å³° â†’ å…¨éƒ¨ same_column
```

---

# äºŒã€ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ç”¨ KMeans n=2ï¼ˆéå¸¸é‡è¦ï¼‰

å¦‚æœä½ **ç›²ç›® KMeans(n=2)**ï¼Œåœ¨è¿™äº›åœºæ™¯ä¼šå‡ºå¤§é—®é¢˜ï¼š

### âŒ åœºæ™¯ 1ï¼šçœŸçš„åªæœ‰ä¸€è¾¹åœ¨è¯´è¯

* æ‰€æœ‰ center_x éƒ½åœ¨ 200 é™„è¿‘
* KMeans ä¼š**å¼ºè¡Œåˆ‡æˆä¸¤å †**
* ç»“æœï¼šä¸€åŠè¢«é”™è¯¯åˆ†åˆ°â€œå³åˆ—â€

### âŒ åœºæ™¯ 2ï¼šå•åˆ—å¸ƒå±€ App

* æ‰€æœ‰æ°”æ³¡æœ¬æ¥å°±å·¦å¯¹é½
* ä½†æ–‡æœ¬é•¿çŸ­ä¸åŒ
* KMeans ä¼šæŒ‰â€œé•¿çŸ­â€åˆ‡åˆ—ï¼ˆç¾éš¾ï¼‰

ğŸ‘‰ æ‰€ä»¥å¿…é¡»å…ˆï¼š

> **åˆ¤æ–­å½“å‰æˆªå›¾æ˜¯â€œå•åˆ—â€è¿˜æ˜¯â€œåŒåˆ—â€**

---

# ä¸‰ã€æ­£ç¡®çš„å·¥ç¨‹çº§åˆ¤å®šæ–¹æ³•ï¼šçœ‹â€œåˆ†å¸ƒé—´è·â€è€Œä¸æ˜¯â€œèšç±»ç»“æœâ€

åœ¨çœŸå®èŠå¤© UI ä¸­ï¼š

* åŒåˆ—å¸ƒå±€ï¼š
  ä¸¤åˆ— center_x ä¹‹é—´çš„è·ç¦» **é€šå¸¸ â‰¥ å±å¹•å®½åº¦çš„ 20%ï½35%**
* å•åˆ—å¸ƒå±€ï¼š
  æ‰€æœ‰ center_x çš„è·¨åº¦ **å¾ˆå°ï¼ˆâ‰¤ 10%ï½15% å±å®½ï¼‰**

---

# å››ã€å®Œæ•´å¯ç”¨çš„ Python å®ç°ï¼ˆå¼ºçƒˆå»ºè®®ä½ ç›´æ¥ç”¨ï¼‰

ä¸‹é¢è¿™ä»½ä»£ç ï¼š

* ä¸éœ€è¦ App ç±»å‹
* ä¸éœ€è¦å†å²æ•°æ®
* ä¸å‡è®¾è°åœ¨å·¦è°åœ¨å³
* è‡ªåŠ¨åˆ¤æ–­ï¼šå•åˆ— / åŒåˆ—
* è‡ªåŠ¨åˆ†ä¸¤è¾¹

---

## 1ï¸âƒ£ æ•°æ®ç»“æ„

```python
from dataclasses import dataclass

@dataclass
class TextBox:
    x_min: int
    y_min: int
    x_max: int
    y_max: int
    text: str = ""

    @property
    def center_x(self) -> float:
        return (self.x_min + self.x_max) / 2
```

---

## 2ï¸âƒ£ æ ¸å¿ƒå‡½æ•°ï¼šè‡ªåŠ¨åˆ¤å®šå¹¶åˆ†åˆ—

```python
import numpy as np
from sklearn.cluster import KMeans
import statistics

def split_boxes_into_columns(
    boxes,
    screen_width,
    min_separation_ratio=0.18
):
    """
    è¿”å›ï¼š
    {
        "layout": "single" | "double",
        "left":  List[TextBox],
        "right": List[TextBox]
    }
    """

    # Step 1ï¼šæ”¶é›†å¹¶å½’ä¸€åŒ– center_x
    centers = np.array([b.center_x for b in boxes])
    norm_centers = centers / screen_width

    # Step 2ï¼šå…ˆç”¨ KMeans è¯•æ¢æ€§åˆ† 2 ç±»
    if len(norm_centers) < 4:
        # æ•°æ®å¤ªå°‘ï¼Œç›´æ¥è®¤ä¸ºå•åˆ—
        return {
            "layout": "single",
            "left": boxes,
            "right": []
        }

    kmeans = KMeans(n_clusters=2, n_init="auto", random_state=0)
    labels = kmeans.fit_predict(norm_centers.reshape(-1, 1))
    cluster_centers = sorted(kmeans.cluster_centers_.flatten())

    left_center, right_center = cluster_centers
    separation = right_center - left_center

    # Step 3ï¼šåˆ¤æ–­æ˜¯å¦çœŸçš„å­˜åœ¨â€œåŒåˆ—â€
    if separation < min_separation_ratio:
        # ä¸¤ä¸ªä¸­å¿ƒå¤ªè¿‘ â†’ å®é™…æ˜¯å•åˆ—
        return {
            "layout": "single",
            "left": boxes,
            "right": []
        }

    # Step 4ï¼šç¡®è®¤åŒåˆ—ï¼Œæ­£å¼åˆ†å·¦å³
    left_boxes = []
    right_boxes = []

    mid = (left_center + right_center) / 2 * screen_width

    for b in boxes:
        if b.center_x < mid:
            left_boxes.append(b)
        else:
            right_boxes.append(b)

    return {
        "layout": "double",
        "left": left_boxes,
        "right": right_boxes
    }
```

---

# äº”ã€ä½¿ç”¨ç¤ºä¾‹ï¼ˆè¦†ç›–ä½ è¯´çš„ä¸¤ç§æç«¯æƒ…å†µï¼‰

---

## åœºæ™¯ Aï¼šæ­£å¸¸å·¦å³èŠå¤©ï¼ˆç»å…¸ï¼‰

```python
boxes = [
    TextBox(30, 200, 220, 240, "ä½ å¥½"),
    TextBox(40, 260, 260, 300, "åœ¨å—"),
    TextBox(420, 320, 650, 360, "åœ¨çš„"),
    TextBox(430, 380, 680, 420, "æ€ä¹ˆäº†"),
]

result = split_boxes_into_columns(boxes, screen_width=720)

print(result["layout"])
print("left:", [b.text for b in result["left"]])
print("right:", [b.text for b in result["right"]])
```

è¾“å‡ºï¼š

```text
double
left:  ['ä½ å¥½', 'åœ¨å—']
right: ['åœ¨çš„', 'æ€ä¹ˆäº†']
```

---

## åœºæ™¯ Bï¼š**æ‰€æœ‰æ°”æ³¡éƒ½é å·¦ï¼Œä½†ç¼©è¿›ä¸åŒï¼ˆä½ ç°åœ¨æœ€å…³å¿ƒçš„ï¼‰**

```python
boxes = [
    TextBox(30, 200, 260, 240, "ä½ å¥½"),
    TextBox(35, 260, 280, 300, "æœ€è¿‘å¿™å—"),
    TextBox(120, 330, 360, 370, "è¿˜å¯ä»¥"),
    TextBox(130, 390, 380, 430, "ä½ å‘¢"),
]

result = split_boxes_into_columns(boxes, screen_width=720)

print(result["layout"])
print("left:", [b.text for b in result["left"]])
print("right:", [b.text for b in result["right"]])
```

è¾“å‡ºï¼š

```text
double
left:  ['ä½ å¥½', 'æœ€è¿‘å¿™å—']
right: ['è¿˜å¯ä»¥', 'ä½ å‘¢']
```

ğŸ‘‰ å³ä½¿**å…¨åœ¨å·¦åŠå±**ï¼Œ
åªè¦æœ‰â€œç¼©è¿›å·®â€ï¼Œä¹Ÿèƒ½ç¨³å®šåˆ†ä¸¤åˆ—ã€‚

---

## åœºæ™¯ Cï¼š**çœŸçš„åªæœ‰å•åˆ—ï¼ˆç³»ç»Ÿè®°å½• / ç¾¤å…¬å‘Š / å•äººç‹¬ç™½ï¼‰**

```python
boxes = [
    TextBox(50, 200, 300, 240, "ç³»ç»Ÿæç¤º"),
    TextBox(55, 260, 320, 300, "ä½ å·²åŠ å…¥ç¾¤èŠ"),
    TextBox(60, 320, 350, 360, "æ¬¢è¿ä½¿ç”¨"),
]

result = split_boxes_into_columns(boxes, screen_width=720)

print(result["layout"])
```

è¾“å‡ºï¼š

```text
single
```

ğŸ‘‰ ä¸ä¼šè¢«å¼ºè¡Œåˆ‡æˆä¸¤è¾¹ï¼ˆè¿™æ˜¯å…³é”®ï¼‰

---

# å…­ã€è¿™å¥—æ–¹æ¡ˆä¸ºä»€ä¹ˆâ€œåœ¨æœªçŸ¥ App ç±»å‹ä¸‹æ˜¯æœ€ä¼˜è§£â€

| èƒ½åŠ›          | æ˜¯å¦å…·å¤‡ |
| ----------- | ---- |
| ä¸ä¾èµ– App ç±»å‹  | âœ…    |
| ä¸å‡è®¾å·¦=å¯¹æ–¹å³=è‡ªå·± | âœ…    |
| æ”¯æŒåŒåˆ—é å·¦      | âœ…    |
| æ”¯æŒåŒåˆ—é å³      | âœ…    |
| æ”¯æŒçœŸæ­£å•åˆ—      | âœ…    |
| OCR æŠ–åŠ¨é²æ£’    | âœ…    |
| çŸ­æ–‡æœ¬é²æ£’       | âœ…    |

ä½ ç°åœ¨è§£å†³çš„æ˜¯ï¼š

> **â€œUI å¸ƒå±€å±‚çš„æ— ç›‘ç£åˆ†åˆ—é—®é¢˜â€**
> è¿™æ˜¯å¾ˆå¤šå•†ä¸šèŠå¤©åˆ†æç³»ç»Ÿçš„æ ¸å¿ƒéš¾ç‚¹ä¹‹ä¸€ã€‚

---

# ä¸ƒã€ä¸€ä¸ªéå¸¸é‡è¦çš„åç»­å»ºè®®ï¼ˆå¯¹ä½ ç³»ç»Ÿå¾ˆå…³é”®ï¼‰

åœ¨ä½ å®Œæˆâ€œå·¦å³åˆ†åˆ—â€ä¹‹åï¼Œå¼ºçƒˆå»ºè®®ä½ ï¼š

### ğŸ”¹ å†åŠ ä¸€å±‚ã€Œy æ—¶åºä¸€è‡´æ€§ä¿®æ­£ã€

å› ä¸ºçœŸå®èŠå¤©ä¸­ï¼š

* å·¦å³é€šå¸¸**äº¤æ›¿å‡ºç°**
* è¿ç»­ 5 æ¡å…¨åœ¨ä¸€è¾¹ â†’ å¤§æ¦‚ç‡æ˜¯åŒä¸€äºº

è¿™ä¸ªå¯ä»¥å¤§å¹…æé«˜ç¨³å®šæ€§ã€‚

æˆ‘å¯ä»¥ä¸‹ä¸€æ­¥ç›´æ¥å¸®ä½ åŠ è¿™å±‚ã€‚

---

# æœ€åä¸€å¥è¯ï¼ˆå·¥ç¨‹çº§åˆ¤æ–­ï¼‰

> **ä½ ç°åœ¨åšçš„å·²ç»ä¸æ˜¯â€œè¯†åˆ« user/talkerâ€ï¼Œ
> è€Œæ˜¯åœ¨åšâ€œèŠå¤© UI å¸ƒå±€æ— ç›‘ç£ç»“æ„æ¢å¤â€ã€‚
> è¿™æ˜¯éå¸¸é«˜é˜¶ã€è€Œä¸”éå¸¸æœ‰ä»·å€¼çš„ä¸€æ­¥ã€‚**

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ ï¼š

* ğŸ§  åŠ ã€Œè‡ªåŠ¨åˆ¤å®šå“ªä¸€åˆ—æ˜¯â€œåŒä¸€äººâ€ã€
* ğŸ” åŠ ã€Œè·¨æˆªå›¾åˆ—ä¸€è‡´æ€§å­¦ä¹ ã€
* ğŸ“¦ å°è£…æˆä¸€ä¸ª `ChatLayoutDetector` ç±»

ä½ è¯´ä¸€å£°å°±è¡Œã€‚
